name: build base php image
on: [push]

jobs:

  build_and_push_to_registry:

    runs-on: ubuntu-latest

    env:
      PHP8_VERSION: 8.1.11
      CADDY_VERSION: 2.6.1
      IMAGE_NAME_CADDY: caddy-ext:2.6.1
      COMPOSER: COMPOSER_MEMORY_LIMIT=-1 composer
      PHP_VER_TAG: 8.1.11-fpm-bullseye
      PHP_EXT_BENCODE_VERSION: 8.1.11-fpm-bullseye
      IMAGE_NAME_BENCODE: php-ext-bencode:8.1.11-fpm-bullseye
      IMAGE_NAME_PHP8: phpfpm-caddy:8.1.11-${{ github.sha }}
      TINI_VERSION: v0.19.0

    steps:
    - run: export
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        buildkitd-flags: --debug

    - name: Log in to Docker Hub
      uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    # - name: Build and push Docker image - ${{ env.IMAGE_NAME_CADDY }}
    #   uses: docker/build-push-action@v4
    #   with:
    #     context: ./base-image/php
    #     file: ./base-image/php/caddy2.Dockerfile
    #     tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_CADDY }}
    #     build-args: |
    #       CADDY_VERSION=${{ env.CADDY_VERSION }}
    #     load: true
    #     cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_CADDY }}-buildcache,mode=max
    #     cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_CADDY }}-buildcache .

    - run: docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_CADDY }}
    - run: docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_CADDY }} ${{ env.IMAGE_NAME_CADDY }}
    - run: docker images

    - name: Build and push Docker image - ${{ env.IMAGE_NAME_BENCODE }}
      uses: docker/build-push-action@v4
      with:
        context: ./base-image/php
        file: ./base-image/php/bencode.Dockerfile
        tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BENCODE }}
        build-args: |
          PHP_VER_TAG=${{ env.PHP_VER_TAG }}
        load: true
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BENCODE }}-buildcache,mode=max
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BENCODE }}-buildcache .
    
    - run: docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BENCODE }}
    - run: docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BENCODE }} ${{ env.IMAGE_NAME_BENCODE }}
    - run: docker images

    - run: sed -i "s/\${PHP_EXT_BENCODE_VERSION}/${{ env.PHP_EXT_BENCODE_VERSION }}/g" ./base-image/php/php8.Dockerfile
    - run: sed -i "s/\${CADDY_VERSION}/${{ env.CADDY_VERSION }}/g" ./base-image/php/php8.Dockerfile
    - run: sed -i "s/\${PHP_VER_TAG}/${{ env.PHP_VER_TAG }}/g" ./base-image/php/php8.Dockerfile
    - run: cat ./base-image/php/php8.Dockerfile

    - name: Build and push Docker image - ${{ env.IMAGE_NAME_PHP8 }}
      uses: docker/build-push-action@v4
      with:
        context: ./base-image/php
        file: ./base-image/php/php8.Dockerfile
        tags:  ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_PHP8 }}
        build-args: |
          PHP_VER_TAG=${{ env.PHP_VER_TAG }}
          PHP_EXT_BENCODE_VERSION=${{ env.PHP_EXT_BENCODE_VERSION }}
          CADDY_VERSION=${{ env.CADDY_VERSION }}
          TINI_VERSION=${{ env.TINI_VERSION }}
        push: true
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_PHP8 }}-buildcache,mode=max
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_PHP8 }}-buildcache .
